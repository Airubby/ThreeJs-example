<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <script type="text/javascript" src="./libs/three.js"></script>
    <script type="text/javascript" src="./libs/jquery-1.9.0.js"></script>
    <script type="text/javascript" src="./libs/stats.js"></script>
    <script type="text/javascript" src="./libs/dat.gui.js"></script>

</head>
<body>
    <div id="Stats-output">
    </div>
    <div id="WebGL-output">
    </div>
<script type="text/javascript">
    var stats= initStats();

    var scene=new THREE.Scene();
    scene.fog = new THREE.Fog(0xffffff, 0.015, 100);
    scene.overrideMaterial = new THREE.MeshLambertMaterial({color: 0xff0000});

    var camera=new THREE.PerspectiveCamera(45,window.innerWidth/window.innerHeight,0.01,1000);
    scene.add(camera);

    var renderer=new THREE.WebGLRenderer();
    renderer.setClearColor(new THREE.Color(0xeeeeee,1));
    renderer.setSize(window.innerWidth,window.innerHeight);
    renderer.shadowMapEnabled=true;

    var planeGeometry=new THREE.PlaneBufferGeometry(60,40,1,1);
    var planeMaterial=new THREE.MeshLambertMaterial({
        color:0xffffff
    });
    var plane=new THREE.Mesh(planeGeometry,planeMaterial);
    plane.receiveShadow=true;
    plane.rotation.x=-0.5*Math.PI;
    plane.position.set(0,0,0);
    scene.add(plane);

    camera.position.set(-30,40,30);
    camera.lookAt(scene.position);

    // add subtle ambient lighting
    var ambientLight = new THREE.AmbientLight(0x0c0c0c);
        scene.add(ambientLight);

        // add spotlight for the shadows
        var spotLight = new THREE.SpotLight(0xffffff);
        spotLight.position.set(-40, 60, -10);
        spotLight.castShadow = true;
        scene.add(spotLight);


    $("#WebGL-output").append(renderer.domElement);

    var step=0;
    var controls=new function(){
        this.rotationSpeed=0.02;
        this.numberOfObjects=scene.children.length;
        this.removeCube=function(){
            var allObject=scene.children;
            var lastObject=allObject[allObject.length-1];
            if(lastObject instanceof THREE.Mesh){
                scene.remove(lastObject);
                this.numberOfObjects=scene.children.length;
            }
        }
        
        this.addCube=function(){
            var cubeGeometry=new THREE.BoxGeometry(Math.ceil(Math.random()*3),Math.ceil(Math.random()*3),Math.ceil(Math.random()*3));
            var cubeMaterial=new THREE.MeshLambertMaterial({
                color:0xfffff*Math.random()
            })
            var cube=new THREE.Mesh(cubeGeometry,cubeMaterial);
            cube.castShadow = true;
            cube.name = "cube-" + scene.children.length;

            var x=-30+Math.round(Math.random()*planeGeometry.parameters.width);
            var y=Math.round(Math.random()*5);
            var z=-20+Math.round(Math.random()*planeGeometry.parameters.height);
            cube.position.set(x,y,z);
            scene.add(cube);
            this.numberOfObjects=scene.children.length;
        }
        this.outputObjects = function () {
            console.log(scene.children);
        }
    }

    var gui=new dat.GUI();
    gui.add(controls,"rotationSpeed",0,0.5);
    gui.add(controls,"numberOfObjects").listen();
    gui.add(controls,"removeCube");
    gui.add(controls,"addCube");
    gui.add(controls,"outputObjects");

    render();
    
    function render(){
        stats.update();
        scene.traverse(function(e){
            if(e instanceof THREE.Mesh && e!=plane){
                e.rotation.x+=controls.rotationSpeed;
                e.rotation.y+=controls.rotationSpeed;
                e.rotation.z+=controls.rotationSpeed;
            }
        })
        requestAnimationFrame(render);
        renderer.render(scene,camera);
    }

    function initStats(){
        var stats=new Stats();
        stats.setMode(0);
        stats.domElement.style.position="absolute";
        stats.domElement.style.left="5px";
        stats.domElement.style.top="5px";
        $("#Stats-output").append(stats.domElement);
        return stats;
    }
</script>
</body>
</html>